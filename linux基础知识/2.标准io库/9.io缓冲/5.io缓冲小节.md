I/O 缓冲小节

本小节对前面学习的内容进行一个简单地总结，概括说明文件 I/O 内核缓冲区和 stdio 缓冲区之间的联

系与区别，以及各种 stdio 库函数，如下图所示：

![1730893069667](images/5.io缓冲小节/1730893069667.png)

图 4.9.9 I/O 缓冲小结

从图中自上而下，首先应用程序调用标准 I/O 库函数将用户数据写入到 stdio 缓冲区中，stdio 缓冲区是

由 stdio 库所维护的用户空间缓冲区。针对不同的缓冲模式，当满足条件时，stdio 库会调用文件 I/O（系统

调用 I/O）将 stdio 缓冲区中缓存的数据写入到内核缓冲区中，内核缓冲区位于内核空间。最终由内核向磁

盘设备发起读写操作，将内核缓冲区中的数据写入到磁盘（或者从磁盘设备读取数据到内核缓冲区）。

应用程序调用库函数可以对 stdio 缓冲区进行相应的设置，设置缓冲区缓冲模式、缓冲区大小以及由调

用者指定一块空间作为 stdio 缓冲区，并且可以强制调用 fflush()函数刷新缓冲区；而对于内核缓冲区来说，

应用程序可以调用相关系统调用对内核缓冲区进行控制，譬如调用 fsync()、fdatasync()或 sync()来刷新内核

缓冲区（或通过 open 指定 O\_SYNC 或 O\_DSYNC 标志），或者使用直接 I/O 绕过内核缓冲区（open 函数

指定 O\_DIRECT 标志）。
